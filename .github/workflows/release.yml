name: Release Obsidian plugin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read current plugin version
        id: get_version
        run: |
          VERSION=$(jq -r '.version' manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Bump patch version
        id: bump
        run: |
          OLD="${{ steps.get_version.outputs.version }}"
          IFS='.' read -r A B C <<< "$OLD"
          NEW="$A.$B.$((C+1))"
          jq ".version = \"$NEW\"" manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json
          echo "new_version=$NEW" >> $GITHUB_OUTPUT

      - name: Build plugin
        run: |
          npm install
          npm run build

      - name: Commit changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add prismjs-supported-languages.json manifest.json
          git commit -m "Update Prism.js languages (auto) ${{ steps.bump.outputs.new_version }}"
          git push

      - name: Release new version
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ steps.bump.outputs.new_version }}"
          name: "${{ steps.bump.outputs.new_version }}"
          body: "Automated release."
          files: |
            main.js
            manifest.json
            prismjs-supported-languages.json
